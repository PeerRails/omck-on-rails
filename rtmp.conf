user www-data;
pid /run/nginx.pid;
worker_processes  1;

#docker run --name rtmp -p 1935:1935 --link nginx:webserver -v /git/omck-on-rails/rtmp.conf:/etc/nginx/nginx.conf -v /data:/data -v /data/logs/rtmp:/var/log/nginx -v /usr/share/nginx/html:/data/logs/stat -d peerrails/nginx-rtmp
#or sameersbn/nginx
#or chakkritte/docker-nginx-rtmp


# Directivs to create to www-data:
# /data/dash/live
# /data/dash/cinema
# /data/dash/records
# /data/hls/live
# /data/hls/cinema
# /data/hls/records
# /data/videos
# /data/stream
# /git
# sudo mkdir -p 777 /var/run/puma && /var/log/puma
# sudo chown puma:www-data /var/run/puma
# sudo apt-get install libav-tools


events {
    worker_connections  1024;
}

http {

    include       mime.types;
    default_type  application/octet-stream;
    types_hash_max_size 4096;

    access_log  /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log crit;
    sendfile        on;
    keepalive_timeout  65;
    server_tokens off;

    gzip  on;

    server {
        listen       127.0.0.1:8080;
        server_name  localhost;
        root /usr/share/nginx/html;
        index index.html index.htm;
        location / {
          try_files \$uri \$uri/ =404;
        }
        location /stat {
          rtmp_stat all;
          rtmp_stat_stylesheet stat.xsl;
        }
        location /stat.xsl {
          root html;
        }

    }
}

rtmp {
        server {
                listen 1935;
                chunk_size 4096;
                buflen 1s;

                application live {
                        live on;
                        notify_method get;
                        record all;
                        record_path /data/stream;
                        record_unique on;
                        on_publish http://webserver/auth_stream;
                        on_record_done http://webserver/channel/move_record;
                        sync 10ms;
                        #push rtmp://localhost/dashlive/omcktv;
                        push rtmp://localhost/hlslive/omcktv;
                }

                application cinema {
                        live on;
                        notify_method get;
                        on_publish http://webserver/auth_stream;
                        on_publish_done http://webserver/end_cinema;
                        idle_streams on;
                        #on_play http://webserver:3000/incr_stream;
                        #on_play_done http://webserver:3000/decr_stream;
                        sync 10ms;
                        #push rtmp://localhost/dashcinema/omcktv;
                        push rtmp://localhost/hlscinema/omcktv;
                }

                application records {
                        live on;
                        notify_method get;
                        allow publish 127.0.0.1;
                        allow publish 172.17.0.0/16;
                        deny publish all;
                        allow play all;
                        sync 10ms;
                        #push rtmp://localhost/dashlive/omcktv;
                        push rtmp://localhost/hlslive/omcktv;
                }

                #HLS
                application hlsrecords {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/records;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        allow publish 172.17.0.0/16;
                        deny publish all;
                        allow play all;
                }
                application hlscinema {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/cinema;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        allow publish 172.17.0.0/16;
                        deny publish all;
                        allow play all;
                }

                application hlslive {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/live;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        allow publish 172.17.0.0/16;
                        deny publish all;
                        allow play all;
                }
        }
}

