
user  vagrant;
worker_processes  1;

# Directivs to create to www-data:
# /data/live/cinema
# /data/live/live
# /data/videos
# /data/stream
# /git
# sudo mkdir -p 777 /var/run/puma && /var/log/puma
# sudo chown puma:www-data /var/run/puma
# sudo apt-get install libav-tools

pid        logs/nginx.pid;


events {
    worker_connections  4096;
}

http {

    include       mime.types;
    default_type  application/octet-stream;
    types_hash_max_size 4096;

    access_log  logs/access.log;
    error_log  logs/error.log;
    sendfile        on;
    keepalive_timeout  65;

    gzip  on;

    server {
        listen       80;
        # Check this
        server_name  localhost;
        root /git/omck-on-rails/public;

        location / {
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /irc {
            root /git/omck-on-rails/public;
        }

        location /download {
          root /data/videos;
          autoindex on;
        }

        location /hls {
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            root /data;
        }

        location /videos {
          root /data;
        }

        location /language {
          root /git/omck-on-rails/public/irc;
        }
    }
}

rtmp {
        server {
                listen 1935;
                chunk_size 4096;
                buflen 1s;

                application live {
                        live on;
                        notify_method get;
                        record all;
                        record_path /data/stream;
                        record_unique on;
                        drop_idle_publisher 20s;
                        on_publish http://localhost:3000/auth_stream;
                        on_record_done http://localhost:3000/channel/move_record;
                        idle_streams on;
                        on_play http://localhost:3000/incr_stream;
                        on_play_done http://localhost:3000/decr_stream;
                        # exec /git/records-of-omck/fallback.sh $name;
                        # exec_kill_signal term;
                        sync 10ms;
                        exec_push avconv -re -i rtmp://localhost/live/omcktv -f flv -b 480k rtmp://localhost/mobilelive/omcktv;
                }

                application cinema {
                        live on;
                        notify_method get;
                        drop_idle_publisher 20s;
                        on_publish http://localhost:3000/auth_stream;
                        on_publish_done http://localhost:3000/end_cinema;
                        idle_streams on;
                        on_play http://localhost:3000/incr_stream;
                        on_play_done http://localhost:3000/decr_stream;
                        sync 10ms;
                        exec_push avconv -re -i rtmp://localhost/cinema/omcktv -f flv -b 480k rtmp://localhost/mobilecinema/omcktv;
                }

                application records {
                        live on;
                        notify_method get;
                        idle_streams on;
                        drop_idle_publisher 20s;
                        allow publish 127.0.0.1;
                        allow publish 172.17.0.0/16;
                        exec_push avconv -re -i rtmp://localhost/records/omcktv -f flv -b 480k rtmp://localhost/mobilerecords/omcktv;
                        deny publish all;
                        allow play all;
                        sync 10ms;
                }

                application mobilerecords {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/records;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        deny publish all;
                        allow play all;
                }
                application mobilecinema {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/cinema;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        deny publish all;
                        allow play all;
                }

                application mobilelive {
                        live on;
                        notify_method get;
                        hls on;
                        hls_path /data/hls/live;
                        hls_fragment 10s;
                        hls_playlist_length 10s;
                        drop_idle_publisher 20s;
                        idle_streams on;
                        #on_play http://localhost:3000/incr_stream;
                        #on_play_done http://localhost:3000/decr_stream;
                        sync 10ms;
                        allow publish 127.0.0.1;
                        deny publish all;
                        allow play all;
                }
        }
}

